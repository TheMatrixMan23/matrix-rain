<!DOCTYPE html>
<html>
<head>
<title>Audio Visualizer</title>
<style>
body {
  background-color: black;
  margin: 0;
  overflow: hidden;
}

#canvas {
  display: block;
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<audio id="audio" controls style="display:none;"></audio>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const audio = document.getElementById('audio');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const filePath = 'LL.m4a'; // *** PASTE YOUR FILE PATH HERE ***
audio.src = filePath;

audio.onerror = function() {
  alert("Error loading audio file. Please check the file path.");
};

audio.onloadeddata = function() {
  audio.play();
  draw();
};


let audioCtx = new AudioContext();
let analyser = audioCtx.createAnalyser();
audio.crossOrigin = "anonymous";
let source = audioCtx.createMediaElementSource(audio);
source.connect(analyser);
analyser.connect(audioCtx.destination);

analyser.fftSize = 2048;
const bufferLength = analyser.frequencyBinCount;
const dataArray = new Uint8Array(bufferLength);

let lastKickTime = 0;
const kickCooldown = 100; // Adjust if needed

// Adaptive Kick Detection (No User Input)
let kickThreshold = 100; // Initial threshold (will be adjusted)
let thresholdAdjustmentFactor = 0.95; // How much to adjust the threshold

function analyzeFrequencyRange(startFreq, endFreq) {
    let sum = 0;
    const startIndex = Math.round(startFreq / audioCtx.sampleRate * analyser.fftSize);
    const endIndex = Math.round(endFreq / audioCtx.sampleRate * analyser.fftSize);
    for (let i = startIndex; i < endIndex; i++) {
        sum += dataArray[i];
    }
    return sum / (endIndex - startIndex);
}

function detectKick() {
    // Analyze a specific low-frequency range (e.g., 20Hz - 100Hz)
    const kickValue = analyzeFrequencyRange(20, 100);

    const currentTime = audio.currentTime * 1000;

    if (kickValue > kickThreshold && currentTime - lastKickTime > kickCooldown) {
        lastKickTime = currentTime;
        // Adjust threshold dynamically based on the current kickValue.
        kickThreshold = Math.max(50, kickValue * thresholdAdjustmentFactor); // Prevent threshold from going too low.
        return true;
    }

    // Gradually decrease the threshold if no kick is detected
    kickThreshold = Math.max(50, kickThreshold * 0.995); // Adjust decay rate as needed.
    return false;
}


function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  analyser.getByteFrequencyData(dataArray);

  if (detectKick()) {
    drawCircle();
  }

  requestAnimationFrame(draw);
}

function drawCircle() {
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.arc(canvas.width / 2, canvas.height / 2, 50, 0, 2 * Math.PI);
  ctx.fill();
}


window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

</script>

</body>
</html>
