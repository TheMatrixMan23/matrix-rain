<!DOCTYPE html>
<html>
<head>
<title>Audio Visualizer</title>
<style>
body {
  background-color: black;
  margin: 0;
  overflow: hidden;
}

#canvas {
  display: block;
}
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<audio id="audio" controls style="display:none;"></audio>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const audio = document.getElementById('audio');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// *** FIXED FILE PATH ***
const filePath = 'LL.m4a'; // Assuming LL.m4a is in the same directory as the HTML file.
audio.src = filePath;


audio.onerror = function() {
  alert("Error loading audio file. Please check the file path.  Is LL.m4a in the same folder as this HTML file?");
};

audio.onloadeddata = function() {
  audio.play();
  draw();
};

let audioCtx = new AudioContext();
let analyser = audioCtx.createAnalyser();
audio.crossOrigin = "anonymous";
let source = audioCtx.createMediaElementSource(audio);
source.connect(analyser);
analyser.connect(audioCtx.destination);

analyser.fftSize = 2048;
const bufferLength = analyser.frequencyBinCount;
const dataArray = new Uint8Array(bufferLength);

let lastKickTime = 0;
const kickCooldown = 150;

// Spike Detection for Kick
let previousLowFrequencyValues = new Array(5).fill(0);
const spikeThresholdMultiplier = 2.0;

function detectKick() {
  const currentTime = audio.currentTime * 1000;

  let currentLowFrequencyValue = analyzeFrequencyRange(20, 50);

  let spikeDetected = false;
  const averagePrevious = previousLowFrequencyValues.reduce((a, b) => a + b, 0) / previousLowFrequencyValues.length;
  if (currentLowFrequencyValue > averagePrevious * spikeThresholdMultiplier) {
      spikeDetected = true;
  }

  previousLowFrequencyValues.shift();
  previousLowFrequencyValues.push(currentLowFrequencyValue);

  if (spikeDetected && currentTime - lastKickTime > kickCooldown) {
    lastKickTime = currentTime;
    return true;
  }

  return false;
}

function analyzeFrequencyRange(startFreq, endFreq) {
    let sum = 0;
    const startIndex = Math.round(startFreq / audioCtx.sampleRate * analyser.fftSize);
    const endIndex = Math.round(endFreq / audioCtx.sampleRate * analyser.fftSize);
    for (let i = startIndex; i < endIndex; i++) {
        sum += dataArray[i];
    }
    return sum / (endIndex - startIndex);
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  analyser.getByteFrequencyData(dataArray);

  if (detectKick()) {
    drawCircle();
  }

  requestAnimationFrame(draw);
}

function drawCircle() {
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.arc(canvas.width / 2, canvas.height / 2, 50, 0, 2 * Math.PI);
  ctx.fill();
}

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

</script>

</body>
</html>
